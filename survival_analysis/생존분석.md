## 생존분석
- 자료의 형태: 어떤 사건이 발생할 때까지 걸리는 시간 (time until an event occurs)
    - 일반적인 regression 문제 아닌가? censored data가 존재하기 때문에 생존분석 접근이 필요하다.
- 자료의 예
    - 사건: 사망, 질병발생, 구독취소
    - 시간: 년, 달, 주
- 분석예시: 전립선 암 치료제 효과 비교
    - 사건: 전립선 암으로 인한 사망
    - 생존시간: randomization시점부터 사망까지의 시간
    - 연구목적: A라는 약을 먹는 집단이 그렇지 않은 집단보다 생존 시간이 더 긴가?

## 생존분석의 특징
- 관심자료가 nonnegative
- 생존시간의 분포는 주로 skewed
- 생존자료가 중도절단(censored)되어 관측
    - 아직 이벤트가 발생하지 않았지만 연구자가 멈추는 경우
    - 우리가 보고 싶은 이벤트 때문이 아니라 다른 이유로 더 이상 관찰을 못하는 경우

## Notation
- $T$: survival time
- $C$: censoring time
$$Y=min(T,C)$$
- status indicator:
$$\delta =
\begin{cases}
1,\;if\;T \le C\\
0,\;if\;T > C
\end{cases}$$

- 우리가 관찰하는 dataset은 $(Y,\delta)$ pair의 형태이다.

## 생존분석에서 관심사
- 생존시간의 분포 파악 (집단 1개)
    - 생존 함수 추정: 주로 Kaplan-Meier 추정법
- 집단 간 생존 분포 비교 (집단 2개 이상)
    - 생존 함수 비교: 주로 log-rank 검정
- 생존시간에 대한 변수들의 효과 파악
    - Cox 회귀 모형

## 생존함수(Survival function)
$$S(t)=P(T>t)=1-F(t)$$
- 특정 시점 $t$보다 더 오래 살 확률

## KM 추정법
$$S_t = \frac{n_t - d_t}{n_t}$$
- $n_t$ : 시간 $t$에 이벤트를 경험할 위험에 놓인 개체의 수
- $d_t$ : 시간 $t$에 이벤트를 경험한 개체의 수

$$\hat{S}(t) = \prod_{i \le t} S_i = \prod_{i \le t} (1 - \frac{d_i}{n_i})$$

- Kaplan-Meier 추정값이라고 한다. (MLE이다)
    - 표준오차를 통해서 신뢰구간도 알 수 있다.
    - 비모수적 생존함수 추정법
- survival curve 를 항상 그려보자.

## 두 집단 생존함수 비교
- 두 집단의 생존함수가 같은지 비교
- 특정 시점에서의 비교가 아니다

$$H_0: S_1(t) = S_2(t), \forall t$$

## log-rank test
- 일관적인 차이를 검출한다.
    - 여기서 일반적인이란 두 그룹의 survival curve를 그렸을 때, 서로 교차하지 않는 것을 의미한다.
    - 교차하게 되면 검정할 수 없다.
- 시점별 다른 가중치를 고려할 수 있다.
- 세 집단 이상도 비교 가능하다.
- 디테일한 과정은 생략하겠습니다.

## 위험도함수(hazard function)
$$h(t) = \lim_{\vartriangle t \rightarrow 0} \frac{P(t < T \le t + \vartriangle t | T > t)}{\vartriangle t}$$
- 특정 시점 $t$까지 살아남았을 때, 시간 단위당 순간 사건 발생률
- 조건부가 존재하기에 확률은 아니다.
- propotional hazards model의 기반이 된다.

## 생존분석에서 식들의 관계
$$h(t) = \lim_{\vartriangle t \rightarrow 0} \frac{P(t < T \le t + \vartriangle t | T > t)}{\vartriangle t}$$
$$= \lim_{\vartriangle t \rightarrow 0} \frac{P( (t < T \le t + \vartriangle t ) \cap (T > t))}{P(T > t) \vartriangle t}$$
$$=\lim_{\vartriangle t \rightarrow 0} \frac{P(t < T \le t + \vartriangle t )/\vartriangle t}{P(T > t) }=\frac{f(t)}{S(t)}$$
- where $f(t) = \lim_{\vartriangle t \rightarrow 0} \frac{P(t < T \le t + \vartriangle t )}{\vartriangle t}$ : probability density function associated with $T$

## Proportional Hazards Model
- survival time을 여러 covariates로 모델링을 하고 싶은 경우 아래와 같이 hazard function의 형태를 가정하여 접근한다.

$$h(t|x_i) = h_0 (t) \exp (\sum_{j=1}^p x_{ij}\beta_j)$$

- where $h_0(t) \ge 0$ is an unspecified function (baseline hazard)
    - functional form에 대한 가정이 없기 때문에 flexible하게 모델링 가능
- 물론 proportional한 가정자체가 이미 한계가 존재하는 것은 사실이다.
- 이외에도 survival forest와 같은 접근법도 존재한다.

위의 내용을 proportional hazard assumption 이라고 한다.

## Partial Likelihood
- 그런데 baseline hazard의 형태를 모르기 때문에 parameter ($\beta$)를 추정할 수 없다.
- 하지만 cox's proportional hazards model에서는 가능하다. how?

## Partial Likelihood
- 가정
    - 일단 이벤트가 발생한 시간이 no ties 를 가정한다.
    - $\delta_i = 1$, 따라서 $t_i = y_i$
- total hazard at time $y_i$ for the at risk observations:
$$\sum_{i' : y_{i'} \ge y_i}h_0(y_i) \exp (\sum_{j=1}^p x_{i'j}\beta_j)$$
- the probability that the *i*th observation is the one to fail at time $y_i$:
$$\frac{h_0(y_i) \exp (\sum_{j=1}^p x_{ij}\beta_j)}{\sum_{i' : y_{i'} \ge y_i}h_0(y_i) \exp (\sum_{j=1}^p x_{i'j}\beta_j)} = \frac{ \exp (\sum_{j=1}^p x_{ij}\beta_j)}{\sum_{i' : y_{i'} \ge y_i} \exp (\sum_{j=1}^p x_{i'j}\beta_j)}$$

## Partial Likelihood

$$PL(\beta) = \prod_{i:\delta_i = 1} \frac{ \exp (\sum_{j=1}^p x_{ij}\beta_j)}{\sum_{i' : y_{i'} \ge y_i} \exp (\sum_{j=1}^p x_{i'j}\beta_j)}$$

- logistic regression 처럼 iterative하게 parameter를 추정한다.
- $\beta$를 추정하면 일반적인 회귀방법론들처럼 계수에 대한 p-value, confidence interval을 구할 수 있다.
- 맨처음 가정이 깨지는 경우, 이를 해결하는 방법들이 있다.

## Reference
- ISLR 2nd edition
- 강상욱 교수님 특장자료
- 알고리즘 마케팅